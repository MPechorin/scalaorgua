<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Functional refactoringin in Scala</title>
    <link rel="stylesheet" href="../../css/reveal.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/code.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
  </head>
<body>
  <div class="reveal">
    <div class="slides">

      <section>
        <div style="height:600px;"><div style="padding:200px 0px 0px 0px;">
        <h2>Functional refactoring in Scala</h2>
        <p>
          by&nbsp;
          <a href="http://linkedin.com/in/polyulya" class="roll"><span data-title="Yuriy Polyulya">Yuriy Polyulya</span></a>
          &nbsp;/&nbsp;
          <a href="http://twitter.com/polyulya" class="roll"><span data-title="@polyulya">@polyulya</span></a>
          &nbsp;/&nbsp;
          <a href="http://cogita-et-visa.blogspot.com" class="roll"><span data-title="+blog">+blog</span></a>
        </p>
        </div></div>
      </section>

      <section>
        <h3 style="text-align:left;">Some update method for:</h3>
        <p style="font-size:50%;text-align:left;">Chess game player score update method. For player with: id, name, last name, games and score fields stored in MongoDB.</p><br/>
        <h4 style="text-align:left;">User class:</h4>
        <pre><code data-trim class="scala">
case class User(
  id        : String,
  name      : String,
  lastName  : String,
  games     : Long,
  score     : Double)
        </code></pre>
        <br/>
        <h4 style="text-align:left;">Database documet:</h4>
        <pre><code data-trim class="scala">
{ "_id" : "yuriy_polyulya@epam.com",
  "name" : "Yuriy",
  "last-name" : "Polyulya",
  "games" : 15,
  "score" : 100.0 }
        </code></pre>
      </section>

      <section>
        <h3 style="text-align:left;">Can looks like:</h3>
        <pre style="height:600px;"><code data-trim class="scala" style="max-height:100%;height:100%;">
def updateScore(id : String, gameScore : Double): Option[DBObject] = {
  val users = MongoClient("localhost")("chess")("users")
  val q = MongoDBObject(ID -> id)

 users.findOne(q) match {
    case Some(dbo)  =>

      val games = dbo.getAs[Long]("games")
      val score = dbo.getAs[Double]("score")

      (games, score) match {
        case (Some(g), Some(s)) =>

          val gamesU = g + 1
          val scoreU = s + gameScore

          val update = $set("games" -> gamesU, "score" -> scoreU)

          users.update(q, update)
          users.findOne(q)

        case _ => None
      }
    case None => None
  }
}
        </code></pre>
      </section>

      <section>
        <h3 style="text-align:left;">Design Issues:</h3>
        <br/>
        <ul style="list-style-type:none;list-style:none; width:100%">
        <ul style="list-style-type:none;list-style:none; width:100%">
          <li class="fragment roll-in" data-fragment-index="1">
          <h4 style="text-align:left;">1. High-coupling:</h4>
          <pre><code data-trim class="scala">
  val users = MongoClient("localhost")("chess")("users")
          </code></pre><br/>
          </li>
          <li class="fragment roll-in" data-fragment-index="2">
          <h4 style="text-align:left;">2. Complexity:</h4>
          <pre><code data-trim class="scala">
  ... match {
        case Some(dbo)  =>
          ... match {
              case (Some(g), Some(s)) =>
                ...
              case _ => None
          }
        case None => None
    }
          </code></pre><br/>
          </li>
          <li class="fragment roll-in" data-fragment-index="3">
          <h4 style="text-align:left;">3. Direct fields using, more...</h4>
          </li>
        </ul>
      </section>

      <section>
        <h3 style="text-align:left;">High-coupling fix:</h3>
        <section>
          <br/>
          <ul style="list-style-type:none;list-style:none; width:100%">
            <li class="fragment roll-in" data-fragment-index="1">
            <h4 style="text-align:left;">1. Service Locator (global collection factory/storage):</h4>
            <pre><code data-trim class="scala">
object ChessMongoCollections {
  lazy val users = MongoClient("localhost")("chess")("users") // or def
}

...

val users = ChessMongoCollections.users
            </code></pre><br/>
            </li>
            <li class="fragment roll-in" data-fragment-index="2">
            <h4 style="text-align:left;">2. Dependency Injection:</h4>
            <pre><code data-trim class="scala">
def updateScore(
  id : String,
  gameScore : Double,
  users : MongoCollection): Option[DBObject] = {

...

}
            </code></pre><br/>
            </li>
          </ul>
        </section>
        <section>
          <h4 style="text-align:left;">Dependency injection after curring:</h4>
          <pre style="height:600px;width:960px"><code data-trim class="scala" style="max-height:100%;height:100%;">
def updateScore(id : String, setScore : Double): Collection => Option[DBObject] =
  users => {
    val q = MongoDBObject(ID -> id)

    users.findOne(q) match {
      case Some(dbo)  =>

        val games = dbo.getAs[Long]("games")
        val score = dbo.getAs[Double]("score")

        (games, score) match {
          case (Some(g), Some(s)) =>
            val gamesU = g + 1
            val scoreU = s + newScore

            val update = $set("games" -> gamesU, "score" -> scoreU)

            users.update(q, update)
            users.findOne(q)

          case _ => None
        }
      case None => None
    }
  }
          </code></pre>
        </section>
      </section>

      <section>
        <h3 style="text-align:left;">Mongo-Collection Reader:</h3>
        <p style="font-size:50%;text-align:left;">Reader - for computations which read values from a shared environment.</p><br/>
        <section>
         <pre><code data-trim class="scala">
case class DB[R](read : MongoCollection => R) {
  def apply(c : MongoCollection): R = read(c)
}
          </code></pre>
          <br/>
          <ul style="list-style-type:none;list-style:none; width:100%">
            <li class="fragment roll-in" data-fragment-index="1">
              <h4 style="text-align:left;">Posible issue:</h4>
              <p style="font-size:50%;">MongoCollection class don't represent data inside it:</p>
              <pre><code data-trim class="scala">
val collectin = MongoClient("localhost")("chess")("games")

// substitute "games" instead "user"!!!
updateScore("a@epam.com", 2.0)(collectin)
              </code></pre>
            </li>
          </ul>
        </section>
        <section>
          <h4 style="text-align:left;">Solution:</h4>
          <p style="font-size:50%;text-align:left;">Use "Tagged type" to mark MongoCollection:</p>
          <pre><code data-trim class="scala">
type Tagged[U] = { type Tag = U }
type @@[T, U] = T with Tagged[U]

def withTag[T](c: MongoCollection) = c.asInstanceOf[MongoCollection @@ T]

type #>[Tag, R] = MongoCollection @@ Tag => R
          </code></pre>
          <br/>
          <p style="font-size:50%;text-align:left;">And DB reader:</p>
          <pre><code data-trim class="scala">
case class DB[CTag, R](read : Tag #> R) {
  def apply(c : MongoCollection @@ CTag): R = read(c)
  def map[B](f : R => B): DB[CTag, B] = DB { read andThen f }
}
          </code></pre>
        </section>
        <br/>
      </section>

      <section>
        <h3 style="text-align:left;">Mongo-Collection Reader:</h3>
        <p style="font-size:50%;text-align:left;">Extend DB Reader for: pass values from function to function, and execute sub-computations in a modified environment.</p><br/>
        <ul style="list-style-type:none;list-style:none; width:100%">
          <li data-fragment-index="1">
            <h4 style="text-align:left;">Lift exist function to Reader:</h4>
            <pre><code data-trim class="scala">
case class DB[CTag, R](read : Tag #> R) {
  ...

  def map[B](f : R => B): DB[CTag, B] = DB { read andThen f }
}
            </code></pre>
            <br/>
          </li>
          <li class="fragment roll-in" data-fragment-index="2">
            <h4 style="text-align:left;">Combine two Readers:</h4>
            <pre><code data-trim class="scala">
case class DB[CTag, R](read : Tag #> R) {
  ...

  def flatMap[B](f : R => DB[CTag, B]): DB[CTag, B] =
    DB { c => (read andThen f)(c).read(c) }
}
            </code></pre>
          </li>
        </ul>
      </section>

      <section>
        <h3 style="text-align:left;">Mongo-Collection Reader:</h3>
        <p style="font-size:50%;text-align:left;"></p><br/>
        <h4 style="text-align:left;">DB Reader class:</h4>
        <pre style="width:960px"><code data-trim class="scala">
case class DB[CTag, R](read : CTag => R) {
  def apply(c : MongoCollection @@ CTag): R = read(c)
  
  def map[B](f : R => B): DB[CTag, B] = DB { read andThen f }
  
  def flatMap[B](f : R => DB[CTag, B]): DB[CTag, B] = 
    DB { c => (read andThen f)(c).read(c) }
}
        </code></pre>
        <br/>
        <h4 style="text-align:left;">DB Reader object (for "pure" method):</h4>
        <pre style="width:960px"><code data-trim class="scala">
object DB {
  def pure[CTag, R](value : => R): DB[CTag, R] = DB { _ => value }

  implicit def funcToDB[CTag, R](f : CTag #> R): DB[CTag, R] = 
    DB(f)
}
        </code></pre>
      </section>

      <section>
        <h3 style="text-align:left;">Update method with DB Reader:</h3>
        <br/>
        <h4 style="text-align:left;">Functionality decomposition:</h4>
        <pre style="width:960px"><code data-trim class="scala">
def getById(id : String): Users #> Option[DBObject] =
  _.findOne(MongoDBObject(ID -> id))

def updateById(id : String, update : DBObject): Users #> Unit =
  _.update(MongoDBObject(ID -> id), update)

        </code></pre>
        <br/>
        <h4 style="text-align:left;">DB Reader object (for "pure" method):</h4>
        <pre style="width:960px"><code data-trim class="scala">

        </code></pre>
        <br/>
      </section>

      <section>
        <h3 style="text-align:left;">Mongo-Collection Reader:</h3>
        <p style="font-size:50%;text-align:left;"></p><br/>

        <br/>
      </section>


    </div>
  </div>

  <script src="../../js/reveal.min.js"></script>
  <script src="../../js/head.min.js"></script>
  <script>
    Reveal.initialize({
      controls: true,
      progress: true,
      rollingLinks: true,
      history: true,
      center: false,
      theme: Reveal.getQueryHash().theme,
      transition: 'default',
      dependencies: [
          { src: '../../js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../../js/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../../js/zoom.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
     });
  </script>
  <script type="text/javascript" src="../../js/highlight.js"></script>
  <script type="text/javascript" src="../../js/zoom.js"></script>
</body>
</html>
